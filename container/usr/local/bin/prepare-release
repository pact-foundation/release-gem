#!/bin/sh
set -euo pipefail

if [ "${DEBUG:-}" = "true" ]; then
  set -x
fi

calculate_release_increment_since_last_release() {
  calculate-release-increment "$(last-release-tag)"
}

version_file() {
  bundle exec bump file --value-only
}

current_version() {
  bundle exec bump current --value-only
}

bump() {
  bundle exec bump ${1} --no-commit
}

if [ -z "${INCREMENT:-}" ]; then
  INCREMENT=$(calculate_release_increment_since_last_release)
fi

if [ -z "${INCREMENT:-}" ]; then
  echo "No feat or fix commits since last release - cancelling release. Set the INCREMENT environment variable to force a release."
  exit 1
fi

bump "${INCREMENT}"
update-changelog
git add CHANGELOG.md "$(version_file)"
git commit -m "chore(release): version $(current_version)"
