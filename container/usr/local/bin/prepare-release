#!/bin/sh

# Set up .netrc file with GitHub credentials
git_setup() {
  git config --global user.email "${GITHUB_ACTOR}@users.noreply.github.com"
  git config --global user.name "${GITHUB_ACTOR}"
    cat <<-EOF >$HOME/.netrc
        machine github.com
        login $GITHUB_ACTOR
        password $GITHUB_TOKEN
        machine api.github.com
        login $GITHUB_ACTOR
        password $GITHUB_TOKEN
EOF
    chmod 600 $HOME/.netrc
}

git_setup

echo "::group::Internal logs"
set -ex

echo "GITHUB_ACTOR = $GITHUB_ACTOR"
echo
git config --list


# Because the BUNDLE_GEMFILE is set on the docker image, everything
# runs in the context of the

increment=${INCREMENT:-patch}
bundle exec bump ${increment} --no-commit
bundle exec ruby -e "
require 'conventional_changelog'
require 'bump'
ConventionalChangelog::Generator.new.generate! version: \"v#{Bump::Bump.current}\"
"
version_file=$(bundle exec bump file --value-only)
version=$(bundle exec bump current --value-only)
git add CHANGELOG.md "${version_file}"
git commit -m "chore(release): version ${version}"

echo "::endgroup::"
