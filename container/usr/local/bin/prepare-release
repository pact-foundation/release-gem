#!/bin/sh
set -euo pipefail

if [ "${DEBUG:-}" = "true" ]; then
  set -x
fi

calculate_release_increment_since_last_release() {
  calculate-release-increment "$(last-release-tag)"
}

version_file() {
  bundle exec bump file --value-only
}

bump() {
  bundle exec bump ${1} --no-commit
}

if [ -n "${INCREMENT:-}" ]; then
  echo "INCREMENT set to '${INCREMENT}' - forcing release"
else
  echo "Calculating increment since last release..."
  INCREMENT=$(calculate_release_increment_since_last_release)
fi

if [ -z "${INCREMENT:-}" ]; then
  echo "No feat or fix commits since last release - cancelling release. Set the INCREMENT environment variable to force a release."
  exit 1
fi

echo "::set-output name=increment::${INCREMENT}"

echo "Performing ${INCREMENT} release"
bump "${INCREMENT}"

echo "Generating RELEASE_NOTES.md"
generate-release-notes

echo "Updating CHANGELOG.md"
update-changelog

git add CHANGELOG.md "$(version_file)"
git commit -m "chore(release): version $(current-version)"
